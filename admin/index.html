<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Paneli - Hasan</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <link rel="icon" type="image/svg+xml" href="/favicon.svg">
  <link rel="stylesheet" href="/css/style.css">
</head>
<body>

  <!-- Login Overlay -->
  <div id="loginOverlay" style="position:fixed;top:0;left:0;width:100%;height:100%;background:var(--dark,#0a0a0a);z-index:99999;display:flex;align-items:center;justify-content:center;">
    <div style="background:var(--card-bg,#1a1a2e);border-radius:16px;padding:40px;max-width:400px;width:90%;box-shadow:0 20px 60px rgba(0,0,0,0.5);text-align:center;">
      <div style="font-size:48px;margin-bottom:16px;"><i class="fas fa-lock" style="color:var(--primary,#6c63ff);"></i></div>
      <h2 style="margin-bottom:8px;color:var(--text,#fff);font-family:'Poppins',sans-serif;">Admin Paneli</h2>
      <p style="margin-bottom:24px;color:var(--dark-light,#888);font-size:14px;">Devam etmek icin giris yapin</p>
      <form id="loginForm" autocomplete="off">
        <input type="email" id="loginEmail" placeholder="E-posta..." style="width:100%;padding:12px 16px;border-radius:8px;border:2px solid var(--border,#333);background:var(--dark,#0a0a0a);color:var(--text,#fff);font-size:16px;font-family:'Poppins',sans-serif;outline:none;box-sizing:border-box;margin-bottom:12px;transition:border-color 0.3s;" onfocus="this.style.borderColor='var(--primary,#6c63ff)'" onblur="this.style.borderColor='var(--border,#333)'" required>
        <input type="password" id="loginPassword" placeholder="Sifre..." style="width:100%;padding:12px 16px;border-radius:8px;border:2px solid var(--border,#333);background:var(--dark,#0a0a0a);color:var(--text,#fff);font-size:16px;font-family:'Poppins',sans-serif;outline:none;box-sizing:border-box;margin-bottom:12px;transition:border-color 0.3s;" onfocus="this.style.borderColor='var(--primary,#6c63ff)'" onblur="this.style.borderColor='var(--border,#333)'" required>
        <div id="loginError" style="color:#ff4757;font-size:13px;margin-bottom:12px;display:none;">Giris basarisiz!</div>
        <button type="submit" style="width:100%;padding:12px;border-radius:8px;border:none;background:var(--primary,#6c63ff);color:#fff;font-size:16px;font-weight:600;font-family:'Poppins',sans-serif;cursor:pointer;transition:opacity 0.3s;" onmouseover="this.style.opacity='0.85'" onmouseout="this.style.opacity='1'"><i class="fas fa-sign-in-alt"></i> Giris Yap</button>
      </form>
    </div>
  </div>

  <!-- Admin Content (hidden until login) -->
  <div id="adminContent" style="display:none;">

  <!-- Skip to Content -->
  <a href="#postForm" class="skip-to-content">Icerigi Atla</a>

  <!-- Preloader -->
  <div class="preloader">
    <div class="preloader-inner">
      <div class="preloader-spinner"></div>
      <div class="preloader-text"></div>
    </div>
  </div>

  <!-- Navbar -->
  <nav class="navbar scrolled">
    <div class="container">
      <a href="/" class="nav-logo">Hasan Keskin</a>
      <ul class="nav-links">
        <li><a href="/">Ana Sayfa</a></li>
        <li><a href="/blog/">Blog</a></li>
        <li><a href="/projects/">Projeler</a></li>
        <li><a href="/cv/">CV</a></li>
        <li><a href="/contact/">Iletisim</a></li>
      </ul>
      <button class="theme-toggle" aria-label="Tema Degistir" title="Tema Degistir">
        <i class="fas fa-moon"></i>
        <i class="fas fa-sun"></i>
      </button>
      <div class="hamburger" role="button" aria-label="Menuyu Ac/Kapat" tabindex="0">
        <span></span>
        <span></span>
        <span></span>
      </div>
    </div>
  </nav>

  <!-- Page Header -->
  <div class="page-header">
    <div class="container">
      <h1><i class="fas fa-cog"></i> Admin Paneli</h1>
      <p>Blog, Proje ve Deneyim Yonetimi</p>
      <button onclick="handleLogout();" style="margin-top:12px;padding:8px 20px;border-radius:8px;border:2px solid rgba(255,255,255,0.3);background:transparent;color:#fff;font-size:14px;font-weight:500;font-family:'Poppins',sans-serif;cursor:pointer;transition:all 0.3s;" onmouseover="this.style.background='rgba(255,255,255,0.1)'" onmouseout="this.style.background='transparent'"><i class="fas fa-sign-out-alt"></i> Cikis Yap</button>
    </div>
  </div>

  <!-- Admin Section -->
  <section class="section">
    <div class="container">

      <form class="admin-form" id="postForm">
        <h3 style="margin-bottom: 24px;" id="formTitle"><i class="fas fa-plus"></i> Yeni Yazi Ekle</h3>

        <div class="form-group">
          <label>Baslik (TR)</label>
          <input type="text" id="titleTr" placeholder="Turkce baslik..." required>
        </div>
        <div class="form-group">
          <label>Baslik (EN)</label>
          <input type="text" id="titleEn" placeholder="English title...">
        </div>
        <div class="form-group">
          <label>Ozet (TR)</label>
          <textarea id="summaryTr" rows="2" placeholder="Kisa ozet..."></textarea>
        </div>
        <div class="form-group">
          <label>Ozet (EN)</label>
          <textarea id="summaryEn" rows="2" placeholder="Short summary..."></textarea>
        </div>
        <div class="form-group">
          <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
            <label style="margin:0;">Icerik (TR) - Markdown & HTML destekler</label>
            <div class="md-toolbar">
              <button type="button" class="md-btn" onclick="mdInsert('contentTr','**','**')" title="Kalin"><i class="fas fa-bold"></i></button>
              <button type="button" class="md-btn" onclick="mdInsert('contentTr','*','*')" title="Italik"><i class="fas fa-italic"></i></button>
              <button type="button" class="md-btn" onclick="mdInsert('contentTr','## ','')" title="Baslik"><i class="fas fa-heading"></i></button>
              <button type="button" class="md-btn" onclick="mdInsert('contentTr','[','](url)')" title="Link"><i class="fas fa-link"></i></button>
              <button type="button" class="md-btn" onclick="mdInsert('contentTr','- ','')" title="Liste"><i class="fas fa-list-ul"></i></button>
              <button type="button" class="md-btn" onclick="mdInsert('contentTr','`','`')" title="Kod"><i class="fas fa-code"></i></button>
              <button type="button" class="md-btn md-preview-btn" onclick="togglePreview('contentTr','previewTr')" title="Onizleme"><i class="fas fa-eye"></i></button>
            </div>
          </div>
          <textarea id="contentTr" rows="8" placeholder="# Baslik&#10;&#10;Paragraf metni. **Kalin** ve *italik* yazi.&#10;&#10;- Liste ogesi 1&#10;- Liste ogesi 2&#10;&#10;`kod parcasi`"></textarea>
          <div class="md-preview" id="previewTr" style="display:none;"></div>
        </div>
        <div class="form-group">
          <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
            <label style="margin:0;">Icerik (EN) - Markdown & HTML destekler</label>
            <div class="md-toolbar">
              <button type="button" class="md-btn" onclick="mdInsert('contentEn','**','**')" title="Bold"><i class="fas fa-bold"></i></button>
              <button type="button" class="md-btn" onclick="mdInsert('contentEn','*','*')" title="Italic"><i class="fas fa-italic"></i></button>
              <button type="button" class="md-btn" onclick="mdInsert('contentEn','## ','')" title="Heading"><i class="fas fa-heading"></i></button>
              <button type="button" class="md-btn" onclick="mdInsert('contentEn','[','](url)')" title="Link"><i class="fas fa-link"></i></button>
              <button type="button" class="md-btn" onclick="mdInsert('contentEn','- ','')" title="List"><i class="fas fa-list-ul"></i></button>
              <button type="button" class="md-btn" onclick="mdInsert('contentEn','`','`')" title="Code"><i class="fas fa-code"></i></button>
              <button type="button" class="md-btn md-preview-btn" onclick="togglePreview('contentEn','previewEn')" title="Preview"><i class="fas fa-eye"></i></button>
            </div>
          </div>
          <textarea id="contentEn" rows="8" placeholder="# Heading&#10;&#10;Paragraph text. **Bold** and *italic* text.&#10;&#10;- List item 1&#10;- List item 2&#10;&#10;`code snippet`"></textarea>
          <div class="md-preview" id="previewEn" style="display:none;"></div>
        </div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
          <div class="form-group">
            <label>Kategori</label>
            <select id="category">
              <option value="devops">DevOps</option>
              <option value="teknoloji">Teknoloji</option>
              <option value="kisisel">Kisisel</option>
            </select>
          </div>
          <div class="form-group">
            <label>Ikon (FontAwesome)</label>
            <input type="text" id="icon" value="fa-file-alt" placeholder="fa-file-alt">
          </div>
        </div>
        <div class="form-group">
          <label>Etiketler (virgülle ayirin)</label>
          <input type="text" id="tags" placeholder="devops, linux, docker, kubernetes...">
        </div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
          <div class="form-group">
            <label>Seri</label>
            <select id="postSeriesId">
              <option value="">-- Seri Yok --</option>
            </select>
          </div>
          <div class="form-group">
            <label>Seri Sirasi</label>
            <input type="number" id="postSeriesOrder" value="0" min="0" placeholder="0">
          </div>
        </div>

        <input type="hidden" id="editId" value="">

        <div class="btn-group" style="margin-top: 16px;">
          <button type="submit" class="btn btn-primary"><i class="fas fa-save"></i> Kaydet</button>
          <button type="button" class="btn btn-outline" onclick="resetForm();">Iptal</button>
        </div>
      </form>

      <!-- Existing Posts -->
      <div class="admin-posts-list" id="adminPostsList">
        <h3 style="margin-bottom: 20px;"><i class="fas fa-list"></i> Mevcut Yazilar</h3>
      </div>

      <!-- ===== SERI YONETIMI ===== -->
      <div class="admin-form" id="seriesSection" style="margin-top:40px;">
        <h3 style="margin-bottom: 24px;" id="seriesFormTitle"><i class="fas fa-layer-group"></i> Seri Yonetimi</h3>

        <form id="seriesFormEl">
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
            <div class="form-group">
              <label>Seri Adi (TR)</label>
              <input type="text" id="seriesTitleTr" placeholder="Turkce seri adi..." required>
            </div>
            <div class="form-group">
              <label>Seri Adi (EN)</label>
              <input type="text" id="seriesTitleEn" placeholder="English series title...">
            </div>
          </div>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
            <div class="form-group">
              <label>Aciklama (TR)</label>
              <textarea id="seriesDescTr" rows="2" placeholder="Turkce aciklama..."></textarea>
            </div>
            <div class="form-group">
              <label>Aciklama (EN)</label>
              <textarea id="seriesDescEn" rows="2" placeholder="English description..."></textarea>
            </div>
          </div>
          <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px;">
            <div class="form-group">
              <label>Ikon</label>
              <input type="text" id="seriesIcon" value="fa-layer-group" placeholder="fa-layer-group">
            </div>
            <div class="form-group">
              <label>Gradient</label>
              <input type="text" id="seriesGradient" value="var(--primary)" placeholder="var(--primary)">
            </div>
            <div class="form-group">
              <label>Durum</label>
              <select id="seriesStatus">
                <option value="active">Aktif</option>
                <option value="completed">Tamamlandi</option>
                <option value="draft">Taslak</option>
              </select>
            </div>
          </div>
          <input type="hidden" id="seriesEditId" value="">
          <div class="btn-group" style="margin-top: 16px;">
            <button type="submit" class="btn btn-primary"><i class="fas fa-save"></i> Kaydet</button>
            <button type="button" class="btn btn-outline" onclick="resetSeriesForm();">Iptal</button>
          </div>
        </form>

        <div class="admin-posts-list" id="adminSeriesList" style="margin-top:24px;">
          <h3 style="margin-bottom:20px;"><i class="fas fa-list"></i> Mevcut Seriler</h3>
        </div>
      </div>

      <!-- ===== PROJE YONETIMI ===== -->
      <div class="admin-form" id="projectSection" style="margin-top:40px;">
        <h3 style="margin-bottom: 24px;" id="projectFormTitle"><i class="fas fa-folder-plus"></i> Proje Yonetimi</h3>

        <form id="projectFormEl">
          <div class="form-group">
            <label>Proje Adi</label>
            <input type="text" id="projName" placeholder="Proje adi..." required>
          </div>
          <div class="form-group">
            <label>Aciklama</label>
            <textarea id="projDesc" rows="3" placeholder="Projenin ne oldugu, kisa aciklama..."></textarea>
          </div>
          <div class="form-group">
            <label>Kullanilan Teknolojiler (virgülle ayirin)</label>
            <input type="text" id="projTech" placeholder="HTML, CSS, JavaScript, Docker...">
          </div>
          <div class="form-group">
            <label>Rolu / Gorevim</label>
            <input type="text" id="projRole" placeholder="Frontend Developer, DevOps Engineer...">
          </div>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
            <div class="form-group">
              <label>Kategori</label>
              <select id="projCategory">
                <option value="web">Web</option>
                <option value="app">Uygulama</option>
                <option value="tool">Arac</option>
              </select>
            </div>
            <div class="form-group">
              <label>Ikon (FontAwesome)</label>
              <input type="text" id="projIcon" value="fa-code" placeholder="fa-code">
            </div>
          </div>
          <input type="hidden" id="projEditId" value="">
          <div class="btn-group" style="margin-top: 16px;">
            <button type="submit" class="btn btn-primary"><i class="fas fa-save"></i> Kaydet</button>
            <button type="button" class="btn btn-outline" onclick="resetProjectForm();">Iptal</button>
          </div>
        </form>

        <div class="admin-posts-list" id="adminProjectsList" style="margin-top:24px;">
          <h3 style="margin-bottom:20px;"><i class="fas fa-list"></i> Mevcut Projeler</h3>
        </div>
      </div>

      <!-- ===== DENEYIM YONETIMI ===== -->
      <div class="admin-form" id="experienceSection" style="margin-top:40px;">
        <h3 style="margin-bottom: 24px;" id="expFormTitle"><i class="fas fa-briefcase"></i> Deneyim Yonetimi</h3>

        <form id="experienceFormEl">
          <div class="form-group">
            <label>Pozisyon / Baslik</label>
            <input type="text" id="expTitle" placeholder="DevOps Engineer, Stajyer..." required>
          </div>
          <div class="form-group">
            <label>Sirket / Kurum</label>
            <input type="text" id="expCompany" placeholder="Sirket adi...">
          </div>
          <div class="form-group">
            <label>Tarih</label>
            <input type="text" id="expDate" placeholder="2025 - Devam Ediyor">
          </div>
          <div class="form-group">
            <label>Aciklama (opsiyonel)</label>
            <textarea id="expDescription" rows="2" placeholder="Kisa aciklama..."></textarea>
          </div>
          <input type="hidden" id="expEditId" value="">
          <div class="btn-group" style="margin-top: 16px;">
            <button type="submit" class="btn btn-primary"><i class="fas fa-save"></i> Kaydet</button>
            <button type="button" class="btn btn-outline" onclick="resetExpForm();">Iptal</button>
          </div>
        </form>

        <div class="admin-posts-list" id="adminExpList" style="margin-top:24px;">
          <h3 style="margin-bottom:20px;"><i class="fas fa-list"></i> Mevcut Deneyimler</h3>
        </div>
      </div>

      <!-- ===== YORUM YONETIMI ===== -->
      <div class="admin-form" id="commentsSection" style="margin-top:40px;">
        <h3 style="margin-bottom: 24px;"><i class="fas fa-comments"></i> Yorum Onaylama</h3>
        <div class="admin-posts-list" id="adminCommentsList"></div>
      </div>

      <!-- ===== ZIYARETCI MESAJLARI ===== -->
      <div class="admin-form" id="guestbookSection" style="margin-top:40px;">
        <h3 style="margin-bottom: 24px;"><i class="fas fa-envelope-open-text"></i> Ziyaretci Mesajlari</h3>
        <div class="admin-posts-list" id="adminGuestbookList"></div>
      </div>

      <!-- Password Change -->
      <div style="margin-top:40px;padding:24px;background:var(--card-bg,#1a1a2e);border-radius:12px;border:1px solid var(--border,#333);">
        <h3 style="margin-bottom:16px;"><i class="fas fa-key"></i> Sifre Degistir</h3>
        <form id="changePasswordForm" autocomplete="off">
          <div class="form-group">
            <label>Yeni Sifre</label>
            <input type="password" id="newPassword" placeholder="Yeni sifre..." required>
          </div>
          <div class="form-group">
            <label>Yeni Sifre (Tekrar)</label>
            <input type="password" id="confirmPassword" placeholder="Yeni sifre tekrar..." required>
          </div>
          <div id="passwordMsg" style="font-size:13px;margin-bottom:12px;display:none;"></div>
          <button type="submit" class="btn btn-primary"><i class="fas fa-save"></i> Sifreyi Guncelle</button>
        </form>
      </div>

    </div>
  </section>

  <!-- Footer -->
  <footer class="footer">
    <div class="container">
      <div class="footer-bottom">
      </div>
    </div>
  </footer>

  </div><!-- /adminContent -->

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="/js/supabase-client.js"></script>
  <script src="/js/blog-data.js"></script>
  <script src="/js/i18n.js"></script>
  <script src="/js/components.js"></script>
  <script src="/js/main.js"></script>
  <script>
    // ===== HTML SANITIZER =====
    function sanitizeHtml(html) {
      html = html.replace(/<script[\s\S]*?<\/script>/gi, '');
      html = html.replace(/<iframe[\s\S]*?<\/iframe>/gi, '');
      html = html.replace(/\son\w+\s*=\s*["'][^"']*["']/gi, '');
      html = html.replace(/\son\w+\s*=\s*[^\s>]+/gi, '');
      html = html.replace(/javascript\s*:/gi, '');
      return html;
    }

    // ===== MARKDOWN SUPPORT =====
    function markdownToHtml(md) {
      let html = md;
      html = html.replace(/```([\s\S]*?)```/g, '<pre><code>$1</code></pre>');
      html = html.replace(/`([^`]+)`/g, '<code>$1</code>');
      html = html.replace(/^### (.+)$/gm, '<h3>$1</h3>');
      html = html.replace(/^## (.+)$/gm, '<h2>$1</h2>');
      html = html.replace(/^# (.+)$/gm, '<h1>$1</h1>');
      html = html.replace(/\*\*\*(.+?)\*\*\*/g, '<strong><em>$1</em></strong>');
      html = html.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
      html = html.replace(/\*(.+?)\*/g, '<em>$1</em>');
      html = html.replace(/!\[([^\]]*)\]\(([^)]+)\)/g, '<img src="$2" alt="$1">');
      html = html.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2">$1</a>');
      html = html.replace(/^- (.+)$/gm, '<li>$1</li>');
      html = html.replace(/(<li>.*<\/li>)/s, '<ul>$1</ul>');
      html = html.replace(/^---$/gm, '<hr>');
      html = html.replace(/^> (.+)$/gm, '<blockquote>$1</blockquote>');
      html = html.replace(/\n\n(?!<)/g, '</p><p>');
      html = html.replace(/(?<!\>)\n(?!\<)/g, '<br>');
      if (!html.startsWith('<')) html = '<p>' + html + '</p>';
      return html;
    }

    function mdInsert(textareaId, before, after) {
      const ta = document.getElementById(textareaId);
      const start = ta.selectionStart;
      const end = ta.selectionEnd;
      const selected = ta.value.substring(start, end);
      ta.value = ta.value.substring(0, start) + before + selected + after + ta.value.substring(end);
      ta.focus();
      ta.selectionStart = start + before.length;
      ta.selectionEnd = start + before.length + selected.length;
    }

    function togglePreview(textareaId, previewId) {
      const ta = document.getElementById(textareaId);
      const preview = document.getElementById(previewId);
      if (preview.style.display === 'none') {
        const content = ta.value;
        preview.innerHTML = sanitizeHtml(content.trim().startsWith('<') ? content : markdownToHtml(content));
        preview.style.display = 'block';
        ta.style.display = 'none';
      } else {
        preview.style.display = 'none';
        ta.style.display = '';
      }
    }

    // ===== BLOG POST MANAGEMENT (Supabase) =====
    let _adminPosts = [];

    async function loadAdminPosts() {
      _adminPosts = await fetchAllPosts();
    }

    async function renderAdminList() {
      await loadAdminPosts();
      const list = document.getElementById('adminPostsList');

      if (_adminPosts.length === 0) {
        list.innerHTML = '<h3 style="margin-bottom:20px;"><i class="fas fa-list"></i> Mevcut Yazilar</h3><p style="color:var(--dark-light); text-align:center; padding:20px;">Henuz yazi eklenmemis.</p>';
        return;
      }

      list.innerHTML = '<h3 style="margin-bottom:20px;"><i class="fas fa-list"></i> Mevcut Yazilar</h3>' +
        _adminPosts.map(p => `
          <div class="admin-post-item">
            <div class="post-info">
              <h4>${p.title.tr}</h4>
              <span>${p.category} | ${p.date}</span>
            </div>
            <div class="post-actions">
              <button class="btn-edit" onclick="editPost(${p.id})"><i class="fas fa-edit"></i> Duzenle</button>
              <button class="btn-delete" onclick="handleDeletePost(${p.id})"><i class="fas fa-trash"></i> Sil</button>
            </div>
          </div>
        `).join('');
    }

    document.getElementById('postForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const editId = document.getElementById('editId').value;
      const gradients = ['var(--primary)', 'var(--primary-light)', 'var(--gradient-1)'];

      const postData = {
        title: { tr: document.getElementById('titleTr').value, en: document.getElementById('titleEn').value || document.getElementById('titleTr').value },
        summary: { tr: document.getElementById('summaryTr').value, en: document.getElementById('summaryEn').value || document.getElementById('summaryTr').value },
        content: {
          tr: (function() { const v = document.getElementById('contentTr').value; return v.trim().startsWith('<') ? v : markdownToHtml(v); })(),
          en: (function() { const v = document.getElementById('contentEn').value || document.getElementById('contentTr').value; return v.trim().startsWith('<') ? v : markdownToHtml(v); })()
        },
        category: document.getElementById('category').value,
        date: new Date().toISOString().split('T')[0],
        icon: document.getElementById('icon').value || 'fa-file-alt',
        gradient: gradients[Math.floor(Math.random() * gradients.length)],
        author: 'Hasan',
        tags: document.getElementById('tags').value.split(',').map(s => s.trim()).filter(Boolean),
        series_id: document.getElementById('postSeriesId').value ? Number(document.getElementById('postSeriesId').value) : null,
        series_order: Number(document.getElementById('postSeriesOrder').value) || 0
      };

      try {
        if (editId) {
          await updateBlogPost(Number(editId), postData);
        } else {
          await insertBlogPost(postData);
        }
        invalidatePostsCache();
        resetForm();
        await renderAdminList();
        if (typeof showToast === 'function') showToast('Yazi kaydedildi!', 'success');
      } catch (err) {
        console.error('Blog post save error:', err);
        if (typeof showToast === 'function') showToast('Hata: ' + err.message, 'error');
      }
    });

    function editPost(id) {
      const post = _adminPosts.find(p => p.id === id);
      if (!post) return;

      document.getElementById('editId').value = post.id;
      document.getElementById('titleTr').value = post.title.tr;
      document.getElementById('titleEn').value = post.title.en || '';
      document.getElementById('summaryTr').value = post.summary.tr;
      document.getElementById('summaryEn').value = post.summary.en || '';
      document.getElementById('contentTr').value = post.content.tr;
      document.getElementById('contentEn').value = post.content.en || '';
      document.getElementById('category').value = post.category;
      document.getElementById('icon').value = post.icon;
      document.getElementById('tags').value = (post.tags || []).join(', ');
      document.getElementById('postSeriesId').value = post.series_id || '';
      document.getElementById('postSeriesOrder').value = post.series_order || 0;
      document.getElementById('formTitle').innerHTML = '<i class="fas fa-edit"></i> Yaziyi Duzenle';
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    async function handleDeletePost(id) {
      if (!confirm('Bu yaziyi silmek istediginize emin misiniz?')) return;
      try {
        await deleteBlogPost(id);
        invalidatePostsCache();
        await renderAdminList();
        if (typeof showToast === 'function') showToast('Yazi silindi', 'info');
      } catch (err) {
        console.error('Delete error:', err);
        if (typeof showToast === 'function') showToast('Hata: ' + err.message, 'error');
      }
    }

    function resetForm() {
      document.getElementById('postForm').reset();
      document.getElementById('editId').value = '';
      document.getElementById('postSeriesId').value = '';
      document.getElementById('postSeriesOrder').value = '0';
      document.getElementById('formTitle').innerHTML = '<i class="fas fa-plus"></i> Yeni Yazi Ekle';
    }

    // ===== SERIES MANAGEMENT (Supabase) =====
    let _adminSeries = [];

    async function loadAdminSeries() {
      _adminSeries = await fetchAllSeries();
    }

    async function renderSeriesList() {
      await loadAdminSeries();
      const list = document.getElementById('adminSeriesList');
      if (_adminSeries.length === 0) {
        list.innerHTML = '<h3 style="margin-bottom:20px;"><i class="fas fa-list"></i> Mevcut Seriler</h3><p style="color:var(--dark-light); text-align:center; padding:20px;">Henuz seri eklenmemis.</p>';
        return;
      }
      const statusLabels = { active: 'Aktif', completed: 'Tamamlandi', draft: 'Taslak' };
      list.innerHTML = '<h3 style="margin-bottom:20px;"><i class="fas fa-list"></i> Mevcut Seriler</h3>' +
        _adminSeries.map(s => `
          <div class="admin-post-item">
            <div class="post-info">
              <h4><i class="fas ${s.icon}"></i> ${s.title.tr}</h4>
              <span>${statusLabels[s.status] || s.status}</span>
            </div>
            <div class="post-actions">
              <button class="btn-edit" onclick="editSeriesAdmin(${s.id})"><i class="fas fa-edit"></i> Duzenle</button>
              <button class="btn-delete" onclick="handleDeleteSeries(${s.id})"><i class="fas fa-trash"></i> Sil</button>
            </div>
          </div>
        `).join('');
    }

    async function populateSeriesDropdown() {
      await loadAdminSeries();
      const sel = document.getElementById('postSeriesId');
      if (!sel) return;
      sel.innerHTML = '<option value="">-- Seri Yok --</option>' +
        _adminSeries.map(s => `<option value="${s.id}">${s.title.tr}</option>`).join('');
    }

    document.getElementById('seriesFormEl').addEventListener('submit', async (e) => {
      e.preventDefault();
      const editId = document.getElementById('seriesEditId').value;
      const seriesData = {
        title: {
          tr: document.getElementById('seriesTitleTr').value.trim(),
          en: document.getElementById('seriesTitleEn').value.trim() || document.getElementById('seriesTitleTr').value.trim()
        },
        description: {
          tr: document.getElementById('seriesDescTr').value.trim(),
          en: document.getElementById('seriesDescEn').value.trim() || document.getElementById('seriesDescTr').value.trim()
        },
        icon: document.getElementById('seriesIcon').value.trim() || 'fa-layer-group',
        gradient: document.getElementById('seriesGradient').value.trim() || 'var(--primary)',
        status: document.getElementById('seriesStatus').value
      };

      try {
        if (editId) {
          await updateSeries(Number(editId), seriesData);
        } else {
          await insertSeries(seriesData);
        }
        invalidateSeriesCache();
        resetSeriesForm();
        await renderSeriesList();
        await populateSeriesDropdown();
        if (typeof showToast === 'function') showToast('Seri kaydedildi!', 'success');
      } catch (err) {
        console.error('Series save error:', err);
        if (typeof showToast === 'function') showToast('Hata: ' + err.message, 'error');
      }
    });

    function editSeriesAdmin(id) {
      const s = _adminSeries.find(s => s.id === id);
      if (!s) return;
      document.getElementById('seriesEditId').value = s.id;
      document.getElementById('seriesTitleTr').value = s.title.tr;
      document.getElementById('seriesTitleEn').value = s.title.en || '';
      document.getElementById('seriesDescTr').value = s.description.tr;
      document.getElementById('seriesDescEn').value = s.description.en || '';
      document.getElementById('seriesIcon').value = s.icon;
      document.getElementById('seriesGradient').value = s.gradient;
      document.getElementById('seriesStatus').value = s.status;
      document.getElementById('seriesFormTitle').innerHTML = '<i class="fas fa-edit"></i> Seriyi Duzenle';
      document.getElementById('seriesSection').scrollIntoView({ behavior: 'smooth' });
    }

    async function handleDeleteSeries(id) {
      if (!confirm('Bu seriyi silmek istediginize emin misiniz?')) return;
      try {
        await deleteSeries(id);
        invalidateSeriesCache();
        await renderSeriesList();
        await populateSeriesDropdown();
        if (typeof showToast === 'function') showToast('Seri silindi', 'info');
      } catch (err) {
        console.error('Delete error:', err);
        if (typeof showToast === 'function') showToast('Hata: ' + err.message, 'error');
      }
    }

    function resetSeriesForm() {
      document.getElementById('seriesFormEl').reset();
      document.getElementById('seriesEditId').value = '';
      document.getElementById('seriesIcon').value = 'fa-layer-group';
      document.getElementById('seriesGradient').value = 'var(--primary)';
      document.getElementById('seriesFormTitle').innerHTML = '<i class="fas fa-layer-group"></i> Seri Yonetimi';
    }

    // ===== PROJECT MANAGEMENT (Supabase) =====
    let _adminProjects = [];

    async function loadAdminProjects() {
      _adminProjects = await fetchProjects();
    }

    async function renderProjectList() {
      await loadAdminProjects();
      const list = document.getElementById('adminProjectsList');
      if (_adminProjects.length === 0) {
        list.innerHTML = '<h3 style="margin-bottom:20px;"><i class="fas fa-list"></i> Mevcut Projeler</h3><p style="color:var(--dark-light); text-align:center; padding:20px;">Henuz proje eklenmemis.</p>';
        return;
      }
      list.innerHTML = '<h3 style="margin-bottom:20px;"><i class="fas fa-list"></i> Mevcut Projeler</h3>' +
        _adminProjects.map(p => `
          <div class="admin-post-item">
            <div class="post-info">
              <h4><i class="fas ${p.icon || 'fa-code'}"></i> ${p.name}</h4>
              <span>${p.category} | ${(p.tech || []).join(', ')}</span>
            </div>
            <div class="post-actions">
              <button class="btn-edit" onclick="editProjectAdmin(${p.id})"><i class="fas fa-edit"></i> Duzenle</button>
              <button class="btn-delete" onclick="handleDeleteProject(${p.id})"><i class="fas fa-trash"></i> Sil</button>
            </div>
          </div>
        `).join('');
    }

    document.getElementById('projectFormEl').addEventListener('submit', async (e) => {
      e.preventDefault();
      const editId = document.getElementById('projEditId').value;
      const projectData = {
        name: document.getElementById('projName').value.trim(),
        description: document.getElementById('projDesc').value.trim(),
        tech: document.getElementById('projTech').value.split(',').map(s => s.trim()).filter(Boolean),
        role: document.getElementById('projRole').value.trim(),
        category: document.getElementById('projCategory').value,
        icon: document.getElementById('projIcon').value.trim() || 'fa-code'
      };

      try {
        if (editId) {
          await updateProject(Number(editId), projectData);
        } else {
          await insertProject(projectData);
        }
        resetProjectForm();
        await renderProjectList();
        if (typeof showToast === 'function') showToast('Proje kaydedildi!', 'success');
      } catch (err) {
        console.error('Project save error:', err);
        if (typeof showToast === 'function') showToast('Hata: ' + err.message, 'error');
      }
    });

    function editProjectAdmin(id) {
      const proj = _adminProjects.find(p => p.id === id);
      if (!proj) return;
      document.getElementById('projEditId').value = proj.id;
      document.getElementById('projName').value = proj.name;
      document.getElementById('projDesc').value = proj.description || '';
      document.getElementById('projTech').value = (proj.tech || []).join(', ');
      document.getElementById('projRole').value = proj.role || '';
      document.getElementById('projCategory').value = proj.category;
      document.getElementById('projIcon').value = proj.icon || 'fa-code';
      document.getElementById('projectFormTitle').innerHTML = '<i class="fas fa-edit"></i> Projeyi Duzenle';
      document.getElementById('projectSection').scrollIntoView({ behavior: 'smooth' });
    }

    async function handleDeleteProject(id) {
      if (!confirm('Bu projeyi silmek istediginize emin misiniz?')) return;
      try {
        await deleteProject(id);
        await renderProjectList();
        if (typeof showToast === 'function') showToast('Proje silindi', 'info');
      } catch (err) {
        console.error('Delete error:', err);
        if (typeof showToast === 'function') showToast('Hata: ' + err.message, 'error');
      }
    }

    function resetProjectForm() {
      document.getElementById('projectFormEl').reset();
      document.getElementById('projEditId').value = '';
      document.getElementById('projIcon').value = 'fa-code';
      document.getElementById('projectFormTitle').innerHTML = '<i class="fas fa-folder-plus"></i> Proje Yonetimi';
    }

    // ===== EXPERIENCE MANAGEMENT (Supabase) =====
    let _adminExps = [];

    async function loadAdminExps() {
      _adminExps = await fetchExperiences();
    }

    async function renderExpList() {
      await loadAdminExps();
      const list = document.getElementById('adminExpList');
      if (_adminExps.length === 0) {
        list.innerHTML = '<h3 style="margin-bottom:20px;"><i class="fas fa-list"></i> Mevcut Deneyimler</h3><p style="color:var(--dark-light); text-align:center; padding:20px;">Henuz deneyim eklenmemis.</p>';
        return;
      }
      list.innerHTML = '<h3 style="margin-bottom:20px;"><i class="fas fa-list"></i> Mevcut Deneyimler</h3>' +
        _adminExps.map(exp => `
          <div class="admin-post-item">
            <div class="post-info">
              <h4>${exp.title}</h4>
              <span>${exp.company} | ${exp.date}</span>
            </div>
            <div class="post-actions">
              <button class="btn-edit" onclick="editExpAdmin(${exp.id})"><i class="fas fa-edit"></i> Duzenle</button>
              <button class="btn-delete" onclick="handleDeleteExp(${exp.id})"><i class="fas fa-trash"></i> Sil</button>
            </div>
          </div>
        `).join('');
    }

    document.getElementById('experienceFormEl').addEventListener('submit', async (e) => {
      e.preventDefault();
      const editId = document.getElementById('expEditId').value;
      const expData = {
        title: document.getElementById('expTitle').value.trim(),
        company: document.getElementById('expCompany').value.trim(),
        date: document.getElementById('expDate').value.trim(),
        description: document.getElementById('expDescription').value.trim()
      };

      try {
        if (editId) {
          await updateExperience(Number(editId), expData);
        } else {
          await insertExperience(expData);
        }
        resetExpForm();
        await renderExpList();
        if (typeof showToast === 'function') showToast('Deneyim kaydedildi!', 'success');
      } catch (err) {
        console.error('Experience save error:', err);
        if (typeof showToast === 'function') showToast('Hata: ' + err.message, 'error');
      }
    });

    function editExpAdmin(id) {
      const exp = _adminExps.find(e => e.id === id);
      if (!exp) return;
      document.getElementById('expEditId').value = exp.id;
      document.getElementById('expTitle').value = exp.title;
      document.getElementById('expCompany').value = exp.company || '';
      document.getElementById('expDate').value = exp.date || '';
      document.getElementById('expDescription').value = exp.description || '';
      document.getElementById('expFormTitle').innerHTML = '<i class="fas fa-edit"></i> Deneyimi Duzenle';
      document.getElementById('experienceSection').scrollIntoView({ behavior: 'smooth' });
    }

    async function handleDeleteExp(id) {
      if (!confirm('Bu deneyimi silmek istediginize emin misiniz?')) return;
      try {
        await deleteExperience(id);
        await renderExpList();
        if (typeof showToast === 'function') showToast('Deneyim silindi', 'info');
      } catch (err) {
        console.error('Delete error:', err);
        if (typeof showToast === 'function') showToast('Hata: ' + err.message, 'error');
      }
    }

    function resetExpForm() {
      document.getElementById('experienceFormEl').reset();
      document.getElementById('expEditId').value = '';
      document.getElementById('expFormTitle').innerHTML = '<i class="fas fa-briefcase"></i> Deneyim Yonetimi';
    }

    // ===== COMMENT MANAGEMENT (Supabase) =====
    async function renderCommentsList() {
      const comments = await fetchAllComments();
      const list = document.getElementById('adminCommentsList');

      if (comments.length === 0) {
        list.innerHTML = '<p style="color:var(--dark-light); text-align:center; padding:20px;">Henuz yorum yok.</p>';
        return;
      }

      list.innerHTML = comments.map(c => {
        const statusBadge = c.approved
          ? '<span style="color:#2ed573; font-size:0.8rem;"><i class="fas fa-check-circle"></i> Onaylandi</span>'
          : '<span style="color:#D97706; font-size:0.8rem;"><i class="fas fa-clock"></i> Onay Bekliyor</span>';
        const approveBtn = c.approved ? '' : `<button class="btn-edit" onclick="handleApproveComment(${c.id})"><i class="fas fa-check"></i> Onayla</button>`;
        const dateStr = c.created_at ? new Date(c.created_at).toLocaleDateString('tr-TR') : '';
        return `
          <div class="admin-post-item">
            <div class="post-info">
              <h4>${escapeHtml(c.name)} <small style="color:var(--dark-light);">(Yazi #${c.post_id})</small></h4>
              <p style="margin:4px 0; font-size:0.9rem;">${escapeHtml(c.text)}</p>
              <span>${dateStr} | ${statusBadge}</span>
            </div>
            <div class="post-actions">
              ${approveBtn}
              <button class="btn-delete" onclick="handleDeleteComment(${c.id})"><i class="fas fa-trash"></i> Sil</button>
            </div>
          </div>
        `;
      }).join('');
    }

    async function handleApproveComment(id) {
      try {
        await approveComment(id);
        await renderCommentsList();
        if (typeof showToast === 'function') showToast('Yorum onaylandi!', 'success');
      } catch (err) {
        console.error('Approve error:', err);
        if (typeof showToast === 'function') showToast('Hata: ' + err.message, 'error');
      }
    }

    async function handleDeleteComment(id) {
      if (!confirm('Bu yorumu silmek istediginize emin misiniz?')) return;
      try {
        await deleteComment(id);
        await renderCommentsList();
        if (typeof showToast === 'function') showToast('Yorum silindi', 'info');
      } catch (err) {
        console.error('Delete error:', err);
      }
    }

    // ===== GUESTBOOK MANAGEMENT (Supabase) =====
    async function renderGuestbookList() {
      const messages = await fetchGuestbookMessages();
      const list = document.getElementById('adminGuestbookList');

      if (messages.length === 0) {
        list.innerHTML = '<p style="color:var(--dark-light); text-align:center; padding:20px;">Henuz mesaj yok.</p>';
        return;
      }

      list.innerHTML = messages.map(msg => {
        const dateStr = msg.created_at ? new Date(msg.created_at).toLocaleDateString('tr-TR', { day: 'numeric', month: 'long', year: 'numeric', hour: '2-digit', minute: '2-digit' }) : '';
        const locationStr = msg.location ? ' | <i class="fas fa-map-marker-alt"></i> ' + escapeHtml(msg.location) : '';
        return `
          <div class="admin-post-item">
            <div class="post-info">
              <h4>${msg.emoji || ''} ${escapeHtml(msg.name)}</h4>
              <p style="margin:4px 0; font-size:0.9rem;">${escapeHtml(msg.message)}</p>
              <span>${dateStr}${locationStr}</span>
            </div>
            <div class="post-actions">
              <button class="btn-delete" onclick="handleDeleteGuestbook(${msg.id})"><i class="fas fa-trash"></i> Sil</button>
            </div>
          </div>
        `;
      }).join('');
    }

    async function handleDeleteGuestbook(id) {
      if (!confirm('Bu mesaji silmek istediginize emin misiniz?')) return;
      try {
        await deleteGuestbookMessage(id);
        await renderGuestbookList();
        if (typeof showToast === 'function') showToast('Mesaj silindi', 'info');
      } catch (err) {
        console.error('Delete error:', err);
      }
    }

    // ===== LOGIN & AUTH (Supabase) =====
    (async function() {
      var overlay = document.getElementById('loginOverlay');
      var content = document.getElementById('adminContent');

      function showAdmin() {
        overlay.style.display = 'none';
        content.style.display = '';
        // Load all data
        renderAdminList();
        renderSeriesList();
        populateSeriesDropdown();
        renderProjectList();
        renderExpList();
        renderCommentsList();
        renderGuestbookList();
      }

      // Check existing session
      var session = await getSession();
      if (session) {
        showAdmin();
      }

      // Login form
      document.getElementById('loginForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        var email = document.getElementById('loginEmail').value;
        var pwd = document.getElementById('loginPassword').value;
        var errEl = document.getElementById('loginError');

        try {
          await signIn(email, pwd);
          showAdmin();
        } catch (err) {
          errEl.textContent = err.message || 'Giris basarisiz!';
          errEl.style.display = 'block';
          document.getElementById('loginPassword').value = '';
          document.getElementById('loginPassword').focus();
        }
      });

      // Password change form
      document.getElementById('changePasswordForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        var newPwd = document.getElementById('newPassword').value;
        var confirmPwd = document.getElementById('confirmPassword').value;
        var msgEl = document.getElementById('passwordMsg');

        msgEl.style.display = 'block';

        if (newPwd.length < 6) {
          msgEl.style.color = '#ff4757';
          msgEl.textContent = 'Yeni sifre en az 6 karakter olmali!';
          return;
        }
        if (newPwd !== confirmPwd) {
          msgEl.style.color = '#ff4757';
          msgEl.textContent = 'Yeni sifreler eslesmiyor!';
          return;
        }

        try {
          await _supabase.auth.updateUser({ password: newPwd });
          msgEl.style.color = '#2ed573';
          msgEl.textContent = 'Sifre basariyla guncellendi!';
          document.getElementById('changePasswordForm').reset();
          setTimeout(function() { msgEl.style.display = 'none'; }, 3000);
        } catch (err) {
          msgEl.style.color = '#ff4757';
          msgEl.textContent = 'Hata: ' + (err.message || 'Sifre guncellenemedi');
        }
      });
    })();

    // Logout handler
    async function handleLogout() {
      try {
        await signOut();
        window.location.reload();
      } catch (err) {
        console.error('Logout error:', err);
      }
    }
  </script>
</body>
</html>
