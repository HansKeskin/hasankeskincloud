<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Blog Yazisi - Hasan</title>
  <meta name="description" content="Hasan'in kisisel blogu - Teknoloji, yazilim ve hayata dair yazilar">
  <meta property="og:title" content="Blog Yazisi - Hasan">
  <meta property="og:description" content="Hasan'in kisisel blogu - Teknoloji, yazilim ve hayata dair yazilar">
  <meta property="og:type" content="article">
  <meta property="og:site_name" content="Hasan Blog">
  <meta property="og:image" content="/images/profile.jpeg">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:image" content="/images/profile.jpeg">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <link rel="icon" type="image/svg+xml" href="/favicon.svg">
  <link rel="stylesheet" href="/css/style.css">
</head>
<body>

  <!-- Skip to Content -->
  <a href="#postContent" class="skip-to-content">Icerigi Atla</a>

  <!-- Reading Progress Bar -->
  <div class="reading-progress"></div>

  <!-- Preloader -->
  <div class="preloader">
    <div class="preloader-inner">
      <div class="preloader-spinner"></div>
      <div class="preloader-text"></div>
    </div>
  </div>

  <!-- Navbar -->
  <nav class="navbar scrolled">
    <div class="container">
      <a href="/" class="nav-logo">Hasan Keskin</a>
      <ul class="nav-links">
        <li><a href="/" data-i18n="nav.home">Ana Sayfa</a></li>
        <li><a href="/blog/" class="active" data-i18n="nav.blog">Blog</a></li>
        <li><a href="/series/" data-i18n="nav.series">Seriler</a></li>
        <li><a href="/projects/" data-i18n="nav.projects">Projeler</a></li>
        <li><a href="/cv/" data-i18n="nav.cv">CV</a></li>
        <li><a href="/contact/" data-i18n="nav.contact">Iletisim</a></li>
      </ul>
      <button class="lang-toggle" aria-label="Dil Degistir" onclick="setLang(getLang()==='tr'?'en':'tr'); renderPost();">EN</button>
      <button class="theme-toggle" aria-label="Tema Degistir" title="Tema Degistir">
        <i class="fas fa-moon"></i>
        <i class="fas fa-sun"></i>
      </button>
      <div class="hamburger" role="button" aria-label="Menuyu Ac/Kapat" tabindex="0">
        <span></span>
        <span></span>
        <span></span>
      </div>
    </div>
  </nav>

  <!-- Page Header -->
  <div class="page-header">
    <div class="parallax-bg">
      <div class="parallax-shape"></div>
      <div class="parallax-shape"></div>
      <div class="parallax-shape"></div>
      <div class="parallax-shape"></div>
    </div>
    <div class="container">
      <h1 id="postTitle">Yukleniyor...</h1>
      <p id="postMeta"></p>
    </div>
  </div>

  <!-- Reading Time Remaining -->
  <div class="reading-remaining" id="readingRemaining"></div>

  <!-- Blog Post Content -->
  <section class="section">
    <div class="container">

      <!-- Series Banner -->
      <div id="seriesBanner" style="display:none;"></div>

      <!-- Table of Contents -->
      <div class="toc" id="tocContainer" style="display:none;">
        <h4><i class="fas fa-list-ol"></i> Icindekiler <i class="fas fa-chevron-down toggle-icon"></i></h4>
        <ul class="toc-list"></ul>
      </div>

      <div class="post-layout">
        <article class="post-content" id="postContent">
          <p>Yukleniyor...</p>
        </article>
        <!-- Like Button -->
        <div class="like-section" id="likeSection">
          <button class="like-btn" id="likeBtn" onclick="toggleLike()">
            <i class="far fa-heart" id="likeIcon"></i>
            <span id="likeCount">0</span>
            <span data-i18n="blog.likes">Begeni</span>
          </button>
        </div>
        <aside class="post-sidebar">
          <div class="sidebar-card">
            <h4><i class="fas fa-share-alt"></i> <span data-i18n="blog.share">Paylas</span></h4>
            <div class="share-buttons">
              <a href="javascript:void(0)" id="shareTwitter" class="share-btn twitter" target="_blank" rel="noopener noreferrer"><i class="fab fa-twitter"></i></a>
              <a href="javascript:void(0)" id="shareLinkedin" class="share-btn linkedin" target="_blank" rel="noopener noreferrer"><i class="fab fa-linkedin-in"></i></a>
              <button class="share-btn copy" id="shareCopy" title="Linki Kopyala"><i class="fas fa-link"></i></button>
            </div>
          </div>
          <!-- Series TOC -->
          <div class="sidebar-card" id="seriesTocCard" style="display:none;">
            <h4><i class="fas fa-layer-group"></i> <span data-i18n="series.toc_title">Seri Icerigi</span></h4>
            <ul class="series-toc-list" id="seriesTocList"></ul>
          </div>
          <!-- Bookmark -->
          <div class="sidebar-card" style="text-align:center;">
            <button class="bookmark-btn" id="postBookmarkBtn" onclick="toggleBookmark(new URLSearchParams(window.location.search).get('id'));" style="font-size:1.1rem; padding:8px 20px;">
              <i class="far fa-bookmark"></i> <span>Okuma Listesine Ekle</span>
            </button>
          </div>
          <!-- Tag Cloud -->
          <div class="sidebar-card">
            <h4><i class="fas fa-tags"></i> <span data-i18n="blog.tags">Etiketler</span></h4>
            <div class="tag-cloud" id="tagCloud"></div>
          </div>
          <!-- Activity Feed -->
          <div class="sidebar-card activity-feed">
            <h4><span class="pulse-dot"></span> Aktivite</h4>
            <div id="activityFeed"></div>
          </div>
          <div class="sidebar-card">
            <a href="/blog/" class="btn btn-outline" style="width:100%; justify-content:center;">
              <i class="fas fa-arrow-left"></i> <span data-i18n="blog.back">Blog'a Don</span>
            </a>
          </div>
        </aside>
      </div>

      <!-- Comments Section -->
      <div class="comments-section fade-in">
        <h3><i class="fas fa-comments"></i> <span data-i18n="blog.comments">Yorumlar</span> (<span id="commentCount">0</span>)</h3>

        <form class="comment-form" id="commentForm">
          <div class="comment-form-row">
            <div class="form-group">
              <input type="text" id="commentName" data-i18n="blog.comment_name" placeholder="Adiniz">
            </div>
          </div>
          <div class="form-group">
            <textarea id="commentText" data-i18n="blog.comment_text" placeholder="Yorumunuz" rows="4"></textarea>
          </div>
          <div class="hn-field" aria-hidden="true">
            <input type="text" id="commentHoneypot" name="website" tabindex="-1" autocomplete="off">
          </div>
          <button type="submit" class="btn btn-primary"><i class="fas fa-paper-plane"></i> <span data-i18n="blog.comment_submit">Yorum Yap</span></button>
        </form>

        <div class="comments-list" id="commentsList">
          <p class="no-comments" data-i18n="blog.no_comments">Henuz yorum yok. Ilk yorumu siz yapin!</p>
        </div>
      </div>

      <!-- Related Posts -->
      <div class="related-posts fade-in" id="relatedPosts">
        <h3><i class="fas fa-newspaper"></i> <span data-i18n="blog.related">Ilgili Yazilar</span></h3>
        <div class="related-grid" id="relatedGrid"></div>
      </div>

    </div>
  </section>

  <!-- Newsletter -->
  <section class="newsletter-section">
    <div class="container">
      <div class="newsletter-box fade-in">
        <h3 data-i18n="newsletter.title">Bulten Aboneligi</h3>
        <p data-i18n="newsletter.desc">Yeni yazilarimdan haberdar olmak icin e-posta adresinizi birakin.</p>
        <form class="newsletter-form" id="newsletterForm">
          <input type="email" data-i18n="newsletter.placeholder" placeholder="E-posta adresiniz" required>
          <div class="hn-field" aria-hidden="true">
            <input type="text" id="nlHoneypot" name="website" tabindex="-1" autocomplete="off">
          </div>
          <button type="submit" class="btn btn-primary" data-i18n="newsletter.btn">Abone Ol</button>
        </form>
      </div>
    </div>
  </section>

  <!-- Footer -->
  <footer class="footer">
    <div class="container">
      <div class="footer-content">
        <div class="footer-about">
          <div class="footer-logo">Hasan Keskin</div>
          <p data-i18n="footer.desc">Teknoloji, yazilim ve hayata dair dusuncelerimi paylastigim kisisel web sitem.</p>
        </div>
        <div>
          <h4 data-i18n="footer.pages">Sayfalar</h4>
          <div class="footer-links">
            <a href="/" data-i18n="nav.home">Ana Sayfa</a>
            <a href="/blog/" data-i18n="nav.blog">Blog</a>
            <a href="/series/" data-i18n="nav.series">Seriler</a>
            <a href="/projects/" data-i18n="nav.projects">Projeler</a>
            <a href="/cv/" data-i18n="nav.cv">CV</a>
            <a href="/contact/" data-i18n="nav.contact">Iletisim</a>
            <a href="/guestbook/" data-i18n="footer.guestbook">Ziyaretci Defteri</a>
            <a href="/sitemap-page/" data-i18n="footer.sitemap">Site Haritasi</a>
          </div>
        </div>
        <div>
          <h4 data-i18n="footer.social">Sosyal Medya</h4>
          <div class="footer-links">
            <a href="https://www.linkedin.com/in/hasan-keskin-7989572a1/" aria-label="LinkedIn" target="_blank" rel="noopener noreferrer"><i class="fab fa-linkedin"></i> LinkedIn</a>
            <a href="https://medium.com/@hasann.keskiin" aria-label="Medium" target="_blank" rel="noopener noreferrer"><i class="fab fa-medium"></i> Medium</a>
          </div>
        </div>
      </div>
      <div class="footer-bottom">
      </div>
    </div>
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="/js/supabase-client.js"></script>
  <script src="/js/blog-data.js"></script>
  <script src="/js/i18n.js"></script>
  <script src="/js/components.js"></script>
  <script src="/js/main.js"></script>
  <script>
    async function renderPost() {
      const params = new URLSearchParams(window.location.search);
      const postId = params.get('id');
      const post = await getPostById(postId);
      const lang = getLang();

      if (!post) {
        document.getElementById('postTitle').textContent = lang === 'tr' ? 'Yazi bulunamadi' : 'Post not found';
        document.getElementById('postContent').innerHTML = '<p>' + (lang === 'tr' ? 'Aradiginiz yazi bulunamadi.' : 'The post you are looking for was not found.') + '</p>';
        return;
      }

      const title = post.title[lang] || post.title.tr;
      const content = post.content[lang] || post.content.tr;
      const readTime = calculateReadingTime(content);

      document.title = title + ' - Hasan';
      document.getElementById('postTitle').textContent = title;
      document.getElementById('postMeta').innerHTML =
        '<i class="far fa-calendar"></i> ' + formatDate(post.date, lang) +
        ' &nbsp; <i class="far fa-clock"></i> ' + readTime + ' ' + t('blog.reading_time') +
        ' &nbsp; <i class="far fa-user"></i> ' + post.author;
      document.getElementById('postContent').innerHTML = content;

      // Share links
      const url = window.location.href;
      document.getElementById('shareTwitter').href = 'https://twitter.com/intent/tweet?text=' + encodeURIComponent(title) + '&url=' + encodeURIComponent(url);
      document.getElementById('shareLinkedin').href = 'https://www.linkedin.com/sharing/share-offsite/?url=' + encodeURIComponent(url);
      document.getElementById('shareCopy').onclick = () => {
        navigator.clipboard.writeText(url);
        document.getElementById('shareCopy').innerHTML = '<i class="fas fa-check"></i>';
        setTimeout(() => { document.getElementById('shareCopy').innerHTML = '<i class="fas fa-link"></i>'; }, 2000);
      };

      await loadComments(postId);
    }

    // Comments
    async function loadComments(postId) {
      const comments = await fetchComments(postId);
      const list = document.getElementById('commentsList');
      const count = document.getElementById('commentCount');
      count.textContent = comments.length;

      if (comments.length === 0) {
        list.innerHTML = '<p class="no-comments">' + t('blog.no_comments') + '</p>';
        return;
      }

      list.innerHTML = comments.map(c => {
        const safeName = escapeHtml(c.name);
        const safeText = escapeHtml(c.text);
        const commentDate = c.created_at ? c.created_at.split('T')[0] : new Date().toISOString().split('T')[0];
        return `
        <div class="comment-item">
          <div class="comment-avatar">${safeName.charAt(0).toUpperCase()}</div>
          <div class="comment-body">
            <div class="comment-header">
              <strong>${safeName}</strong>
              <span>${formatDate(commentDate, getLang())}</span>
            </div>
            <p>${safeText}</p>
          </div>
        </div>
      `; }).join('');
    }

    if (typeof initSpamProtection === 'function') initSpamProtection('commentForm');

    document.getElementById('commentForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      if (typeof checkSpamProtection === 'function' && !checkSpamProtection('commentForm', 'commentHoneypot')) {
        if (typeof showToast === 'function') showToast('Lutfen formu tekrar doldurun.', 'error');
        return;
      }

      const postId = new URLSearchParams(window.location.search).get('id');
      const name = document.getElementById('commentName').value.trim();
      const text = document.getElementById('commentText').value.trim();
      if (name.length < 2 || text.length < 3) return;

      try {
        await insertComment(Number(postId), name, text);
      } catch (err) {
        console.error('Comment error:', err);
      }

      document.getElementById('commentName').value = '';
      document.getElementById('commentText').value = '';
      await loadComments(postId);
      if (typeof markFormSubmitted === 'function') markFormSubmitted('commentForm');
      if (typeof launchConfetti === 'function') launchConfetti();
      if (typeof showToast === 'function') showToast('Yorumunuz admin onayina gonderildi!', 'success');
      if (typeof logActivity === 'function') logActivity('comment', name + ' yorum yapti');
    });

    // Like System
    function toggleLike() {
      const postId = new URLSearchParams(window.location.search).get('id');
      const likes = JSON.parse(localStorage.getItem('post_likes') || '{}');
      const likedPosts = JSON.parse(localStorage.getItem('liked_posts') || '[]');
      const currentLikes = likes[postId] || 0;
      const isLiked = likedPosts.includes(postId);

      if (isLiked) {
        likes[postId] = Math.max(0, currentLikes - 1);
        const idx = likedPosts.indexOf(postId);
        likedPosts.splice(idx, 1);
      } else {
        likes[postId] = currentLikes + 1;
        likedPosts.push(postId);
        if (typeof logActivity === 'function') logActivity('like', 'Yazi begenildi');
      }

      localStorage.setItem('post_likes', JSON.stringify(likes));
      localStorage.setItem('liked_posts', JSON.stringify(likedPosts));
      updateLikeUI(postId);
    }

    function updateLikeUI(postId) {
      const likes = JSON.parse(localStorage.getItem('post_likes') || '{}');
      const likedPosts = JSON.parse(localStorage.getItem('liked_posts') || '[]');
      const isLiked = likedPosts.includes(postId);

      document.getElementById('likeCount').textContent = likes[postId] || 0;
      const icon = document.getElementById('likeIcon');
      const btn = document.getElementById('likeBtn');
      if (isLiked) {
        icon.className = 'fas fa-heart';
        btn.classList.add('liked');
      } else {
        icon.className = 'far fa-heart';
        btn.classList.remove('liked');
      }
    }

    // Related Posts (score-based)
    async function renderRelatedPosts(currentPost) {
      const lang = getLang();
      const all = await getAllPosts();
      const others = all.filter(p => p.id !== currentPost.id);
      const currentTags = currentPost.tags || [];
      const currentDate = new Date(currentPost.date);
      const oneYearMs = 365 * 24 * 60 * 60 * 1000;

      const scored = others.map(p => {
        let score = 0;
        // Tag matches: 3 pts each
        const pTags = p.tags || [];
        currentTags.forEach(t => { if (pTags.includes(t)) score += 3; });
        // Same category: 2 pts
        if (p.category === currentPost.category) score += 2;
        // Recency bonus: 0-1 pts (newer within 1 year = higher)
        const diff = Math.abs(new Date(p.date) - currentDate);
        if (diff < oneYearMs) score += 1 - (diff / oneYearMs);
        return { post: p, score };
      });

      scored.sort((a, b) => b.score - a.score);
      const related = scored.slice(0, 3).map(s => s.post);

      const grid = document.getElementById('relatedGrid');
      const container = document.getElementById('relatedPosts');
      if (related.length === 0) {
        container.style.display = 'none';
        return;
      }

      grid.innerHTML = related.map(p => {
        const title = p.title[lang] || p.title.tr;
        const summary = p.summary[lang] || p.summary.tr;
        return `
          <a href="/blog-post/?id=${p.id}" class="related-card">
            <div class="related-icon" style="background: ${p.gradient};">
              <i class="fas ${p.icon}"></i>
            </div>
            <div class="related-info">
              <h4>${title}</h4>
              <p>${summary.substring(0, 80)}...</p>
              <span><i class="far fa-calendar"></i> ${formatDate(p.date, lang)}</span>
            </div>
          </a>
        `;
      }).join('');
    }

    // Tag Cloud - reads tags from all posts
    async function renderTagCloud() {
      const allPosts = await getAllPosts();
      const tagSet = new Set();
      allPosts.forEach(p => {
        if (p.tags && Array.isArray(p.tags)) {
          p.tags.forEach(t => tagSet.add(t));
        }
      });
      const cloud = document.getElementById('tagCloud');
      if (!cloud) return;
      const tags = Array.from(tagSet);
      if (tags.length === 0) {
        cloud.innerHTML = '<span style="color:var(--dark-light); font-size:0.85rem;">Henuz etiket yok</span>';
        return;
      }
      cloud.innerHTML = tags.map(tag =>
        `<a href="/blog/?tag=${encodeURIComponent(tag)}" class="tag-item">${tag}</a>`
      ).join('');
    }

    // Override renderPost to include new features
    const originalRenderPost = renderPost;
    renderPost = async function() {
      await originalRenderPost();
      const params = new URLSearchParams(window.location.search);
      const postId = params.get('id');
      const post = await getPostById(postId);
      if (post) {
        updateLikeUI(postId);
        await renderRelatedPosts(post);

        // Track view (only once per page load)
        if (!window._viewTracked) {
          window._viewTracked = true;
          if (typeof trackPostView === 'function') trackPostView(postId);
          const lang = getLang();
          if (typeof logActivity === 'function') {
            logActivity('view', (post.title[lang] || post.title.tr) + ' okundu');
          }
        }

        const lang = getLang();

        // Render activity feed
        if (typeof renderActivityFeed === 'function') renderActivityFeed();

        // Generate Table of Contents
        if (typeof generateTOC === 'function') generateTOC();

        // Reading time remaining
        const content = post.content[lang] || post.content.tr;
        const readTime = calculateReadingTime(content);
        if (typeof initReadingRemaining === 'function') initReadingRemaining(readTime);

        // Update bookmark button
        const bmBtn = document.getElementById('postBookmarkBtn');
        if (bmBtn && typeof isBookmarked === 'function') {
          const bm = isBookmarked(postId);
          bmBtn.setAttribute('data-post-id', postId);
          bmBtn.classList.toggle('bookmarked', bm);
          bmBtn.querySelector('i').className = bm ? 'fas fa-bookmark' : 'far fa-bookmark';
          bmBtn.querySelector('span').textContent = bm ? 'Okuma Listesinde' : 'Okuma Listesine Ekle';
          // Wrap toggleBookmark to log activity
          const origToggle = window.toggleBookmark;
          if (origToggle && !bmBtn._patched) {
            bmBtn._patched = true;
            bmBtn.onclick = function() {
              origToggle(postId);
              if (typeof logActivity === 'function') logActivity('bookmark', 'Yazi kaydedildi');
              renderPost();
            };
          }
        }

        // Render series navigation
        await renderSeriesNav(post);
      }
      await renderTagCloud();
    };

    async function renderSeriesNav(post) {
      const nav = await getSeriesNavigation(post.id);
      if (!nav) return;

      const lang = getLang();
      const seriesTitle = nav.series.title[lang] || nav.series.title.tr;
      const progress = nav.currentIndex + 1;
      const total = nav.total;
      const pct = Math.round((progress / total) * 100);

      // Render sticky banner
      const banner = document.getElementById('seriesBanner');
      let prevBtn = nav.prev
        ? `<a href="/blog-post/?id=${nav.prev.id}" class="series-nav-btn"><i class="fas fa-chevron-left"></i> ${t('series.prev')}</a>`
        : `<span class="series-nav-btn disabled"><i class="fas fa-chevron-left"></i> ${t('series.prev')}</span>`;
      let nextBtn = nav.next
        ? `<a href="/blog-post/?id=${nav.next.id}" class="series-nav-btn">${t('series.next')} <i class="fas fa-chevron-right"></i></a>`
        : `<span class="series-nav-btn disabled">${t('series.next')} <i class="fas fa-chevron-right"></i></span>`;

      banner.style.display = 'block';
      banner.innerHTML = `
        <div class="series-banner">
          <div class="series-banner-inner">
            <div class="series-banner-info">
              <i class="fas ${nav.series.icon}"></i>
              <div>
                <div class="series-banner-title"><a href="/series/?id=${nav.series.id}">${seriesTitle}</a></div>
                <div class="series-banner-count">${t('series.part')} ${progress}/${total}</div>
              </div>
            </div>
            <div class="series-banner-nav">
              ${prevBtn}
              ${nextBtn}
            </div>
          </div>
          <div class="series-progress-bar">
            <div class="series-progress-fill" style="width: ${pct}%"></div>
          </div>
        </div>
      `;

      // Render sidebar TOC
      const tocCard = document.getElementById('seriesTocCard');
      const tocList = document.getElementById('seriesTocList');
      tocCard.style.display = 'block';
      tocList.innerHTML = nav.posts.map((p, i) => {
        const pTitle = p.title[lang] || p.title.tr;
        const isActive = p.id === post.id;
        return `
          <li>
            <a href="/blog-post/?id=${p.id}" class="series-toc-item ${isActive ? 'active' : ''}">
              <span class="series-toc-num">${i + 1}</span>
              <span class="series-toc-title">${pTitle}</span>
            </a>
          </li>
        `;
      }).join('');
    }

    renderPost();

    // Reading mode hint (once per user)
    if (!localStorage.getItem('reading_mode_hint')) {
      setTimeout(() => {
        if (typeof showToast === 'function') {
          showToast('<kbd style="background:rgba(255,255,255,0.2);padding:2px 6px;border-radius:4px;">R</kbd> tusuna basarak okuma modunu acabilirsiniz', 'info');
          localStorage.setItem('reading_mode_hint', 'true');
        }
      }, 3000);
    }

    // Newsletter form handler
    const nlForm = document.getElementById('newsletterForm');
    if (nlForm) {
      if (typeof initSpamProtection === 'function') initSpamProtection('newsletterForm');
      nlForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        if (typeof checkSpamProtection === 'function' && !checkSpamProtection('newsletterForm', 'nlHoneypot')) {
          if (typeof showToast === 'function') showToast('Lutfen formu tekrar doldurun.', 'error');
          return;
        }
        const email = e.target.querySelector('input[type="email"]').value.trim();
        if (!email) return;
        try {
          await insertNewsletterSub(email);
        } catch (err) {
          console.error('Newsletter error:', err);
        }
        e.target.querySelector('input[type="email"]').value = '';
        const btn = e.target.querySelector('button');
        btn.textContent = t('newsletter.success');
        if (typeof markFormSubmitted === 'function') markFormSubmitted('newsletterForm');
        if (typeof launchConfetti === 'function') launchConfetti();
        if (typeof logActivity === 'function') logActivity('newsletter', 'Bultene abone olundu');
        setTimeout(() => { btn.textContent = t('newsletter.btn'); }, 3000);
      });
    }
  </script>
</body>
</html>
